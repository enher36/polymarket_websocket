<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polymarket Monitor</title>
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-green: #22c55e;
      --accent-green-glow: rgba(34, 197, 94, 0.3);
      --accent-red: #ef4444;
      --accent-red-glow: rgba(239, 68, 68, 0.3);
      --accent-blue: #3b82f6;
      --border-color: #475569;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 24px;
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-left h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .header-left p {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .lang-switch {
      display: flex;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .lang-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .lang-btn:hover {
      color: var(--text-primary);
    }

    .lang-btn.active {
      background: var(--accent-blue);
      color: white;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 9999px;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .status-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
      animation: pulse 2s infinite;
    }

    .status-badge.error .dot {
      background: var(--accent-red);
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.2);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .card-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      font-weight: 600;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .icon-upstream { background: rgba(59, 130, 246, 0.2); }
    .icon-market { background: rgba(34, 197, 94, 0.2); }
    .icon-downstream { background: rgba(168, 85, 247, 0.2); }
    .icon-uptime { background: rgba(251, 191, 36, 0.2); }

    .card-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-value .indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .indicator.connected {
      background: var(--accent-green);
      box-shadow: 0 0 12px var(--accent-green-glow);
    }

    .indicator.disconnected {
      background: var(--accent-red);
      box-shadow: 0 0 12px var(--accent-red-glow);
    }

    .card-subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .card-subtitle span {
      color: var(--text-primary);
      font-weight: 500;
    }

    footer {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 0.875rem;
      border-top: 1px solid var(--border-color);
    }

    footer code {
      background: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 0.8rem;
    }

    .error-state {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--accent-red);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      color: var(--accent-red);
      margin-bottom: 20px;
    }

    @media (max-width: 640px) {
      body { padding: 16px; }
      header { flex-direction: column; align-items: flex-start; }
      .header-left h1 { font-size: 1.5rem; }
      .card-value { font-size: 1.5rem; }
      .header-right { width: 100%; justify-content: space-between; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <h1 data-i18n="title">Polymarket Realtime Monitor</h1>
        <p data-i18n="subtitle">Live statistics from upstream and downstream connections</p>
      </div>
      <div class="header-right">
        <div class="lang-switch">
          <button class="lang-btn active" data-lang="en">EN</button>
          <button class="lang-btn" data-lang="zh">中文</button>
        </div>
        <div class="status-badge" id="status-badge">
          <span class="dot"></span>
          <span><span data-i18n="lastUpdated">Last updated</span>: <span id="last-updated">--</span></span>
        </div>
      </div>
    </header>

    <div id="error-container"></div>

    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-label" data-i18n="upstream">Upstream Connection</span>
          <div class="card-icon icon-upstream">&#x1F4E1;</div>
        </div>
        <div class="card-value">
          <span class="indicator" id="upstream-indicator"></span>
          <span id="upstream-status">--</span>
        </div>
        <div class="card-subtitle">
          <span data-i18n="subscriptions">Subscriptions</span>: <span id="upstream-subs">0</span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-label" data-i18n="activeMarkets">Active Markets</span>
          <div class="card-icon icon-market">&#x1F4CA;</div>
        </div>
        <div class="card-value" id="active-markets">0</div>
        <div class="card-subtitle" data-i18n="marketsDesc">Markets tracked in database</div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-label" data-i18n="downstream">Downstream Clients</span>
          <div class="card-icon icon-downstream">&#x1F465;</div>
        </div>
        <div class="card-value" id="downstream-clients">0</div>
        <div class="card-subtitle">
          <span data-i18n="subscriptions">Subscriptions</span>: <span id="downstream-subs">0</span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-label" data-i18n="uptime">Uptime</span>
          <div class="card-icon icon-uptime">&#x23F1;</div>
        </div>
        <div class="card-value" id="uptime">--</div>
        <div class="card-subtitle" data-i18n="uptimeDesc">Since application start</div>
      </div>
    </div>

    <footer>
      <span data-i18n="autoRefresh">Auto-refreshes every 3 seconds</span> &bull;
      API: <code>/api/health</code> <code>/api/metrics</code>
    </footer>
  </div>

  <script>
    // Internationalization
    const i18n = {
      en: {
        title: 'Polymarket Realtime Monitor',
        subtitle: 'Live statistics from upstream and downstream connections',
        lastUpdated: 'Last updated',
        upstream: 'Upstream Connection',
        downstream: 'Downstream Clients',
        activeMarkets: 'Active Markets',
        uptime: 'Uptime',
        subscriptions: 'Subscriptions',
        marketsDesc: 'Markets tracked in database',
        uptimeDesc: 'Since application start',
        autoRefresh: 'Auto-refreshes every 3 seconds',
        connected: 'Connected',
        disconnected: 'Disconnected',
        error: 'Error',
        fetchFailed: 'Failed to fetch metrics'
      },
      zh: {
        title: 'Polymarket 实时监控',
        subtitle: '上游和下游连接的实时统计数据',
        lastUpdated: '最后更新',
        upstream: '上游连接',
        downstream: '下游客户端',
        activeMarkets: '活跃市场',
        uptime: '运行时间',
        subscriptions: '订阅数',
        marketsDesc: '数据库中跟踪的市场',
        uptimeDesc: '自应用启动以来',
        autoRefresh: '每3秒自动刷新',
        connected: '已连接',
        disconnected: '已断开',
        error: '错误',
        fetchFailed: '获取指标失败'
      }
    };

    let currentLang = localStorage.getItem('lang') || 'en';

    function setLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('lang', lang);

      // Update button states
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      // Update all i18n elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (i18n[lang][key]) {
          el.textContent = i18n[lang][key];
        }
      });

      // Update dynamic content
      updateDynamicText();
    }

    function t(key) {
      return i18n[currentLang][key] || key;
    }

    function updateDynamicText() {
      const upstreamStatus = document.getElementById('upstream-status');
      if (upstreamStatus) {
        const isConnected = upstreamStatus.dataset.connected === 'true';
        upstreamStatus.textContent = isConnected ? t('connected') : t('disconnected');
      }
    }

    // Language switch handlers
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
    });

    const elements = {
      statusBadge: document.getElementById('status-badge'),
      lastUpdated: document.getElementById('last-updated'),
      errorContainer: document.getElementById('error-container'),
      upstreamIndicator: document.getElementById('upstream-indicator'),
      upstreamStatus: document.getElementById('upstream-status'),
      upstreamSubs: document.getElementById('upstream-subs'),
      activeMarkets: document.getElementById('active-markets'),
      downstreamClients: document.getElementById('downstream-clients'),
      downstreamSubs: document.getElementById('downstream-subs'),
      uptime: document.getElementById('uptime'),
    };

    function formatDuration(totalSeconds) {
      const seconds = Math.max(0, Math.floor(totalSeconds));
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;

      if (currentLang === 'zh') {
        if (days > 0) return `${days}天 ${hours}小时 ${mins}分`;
        if (hours > 0) return `${hours}小时 ${mins}分 ${secs}秒`;
        if (mins > 0) return `${mins}分 ${secs}秒`;
        return `${secs}秒`;
      } else {
        if (days > 0) return `${days}d ${hours}h ${mins}m`;
        if (hours > 0) return `${hours}h ${mins}m ${secs}s`;
        if (mins > 0) return `${mins}m ${secs}s`;
        return `${secs}s`;
      }
    }

    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      }
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toLocaleString();
    }

    function showError(message) {
      elements.errorContainer.innerHTML = `
        <div class="error-state">
          ${t('fetchFailed')}: ${message}
        </div>
      `;
      elements.statusBadge.classList.add('error');
    }

    function clearError() {
      elements.errorContainer.innerHTML = '';
      elements.statusBadge.classList.remove('error');
    }

    function updateUI(data) {
      clearError();

      const upstreamConnected = data.upstream?.connected ?? false;
      elements.upstreamIndicator.className = `indicator ${upstreamConnected ? 'connected' : 'disconnected'}`;
      elements.upstreamStatus.dataset.connected = upstreamConnected;
      elements.upstreamStatus.textContent = upstreamConnected ? t('connected') : t('disconnected');
      elements.upstreamSubs.textContent = formatNumber(data.upstream?.subscriptions ?? 0);

      elements.activeMarkets.textContent = formatNumber(data.markets?.active_count ?? 0);
      elements.downstreamClients.textContent = formatNumber(data.downstream?.clients ?? 0);
      elements.downstreamSubs.textContent = formatNumber(data.downstream?.subscriptions ?? 0);
      elements.uptime.textContent = formatDuration(data.uptime_seconds ?? 0);

      const timestamp = data.timestamp ? new Date(data.timestamp) : new Date();
      elements.lastUpdated.textContent = timestamp.toLocaleTimeString();
    }

    async function fetchMetrics() {
      try {
        const response = await fetch('/api/metrics');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        updateUI(data);
      } catch (error) {
        showError(error.message);
        console.error('Metrics fetch error:', error);
      }
    }

    // Initialize
    setLanguage(currentLang);
    fetchMetrics();
    setInterval(fetchMetrics, 3000);
  </script>
</body>
</html>
